%% Generated by Sphinx.
\def\sphinxdocclass{report}
\documentclass[a4paper,10pt,english]{sphinxmanual}
\ifdefined\pdfpxdimen
   \let\sphinxpxdimen\pdfpxdimen\else\newdimen\sphinxpxdimen
\fi \sphinxpxdimen=.75bp\relax
\ifdefined\pdfimageresolution
    \pdfimageresolution= \numexpr \dimexpr1in\relax/\sphinxpxdimen\relax
\fi
%% let collapsible pdf bookmarks panel have high depth per default
\PassOptionsToPackage{bookmarksdepth=5}{hyperref}

\PassOptionsToPackage{warn}{textcomp}
\usepackage[utf8]{inputenc}
\ifdefined\DeclareUnicodeCharacter
% support both utf8 and utf8x syntaxes
  \ifdefined\DeclareUnicodeCharacterAsOptional
    \def\sphinxDUC#1{\DeclareUnicodeCharacter{"#1}}
  \else
    \let\sphinxDUC\DeclareUnicodeCharacter
  \fi
  \sphinxDUC{00A0}{\nobreakspace}
  \sphinxDUC{2500}{\sphinxunichar{2500}}
  \sphinxDUC{2502}{\sphinxunichar{2502}}
  \sphinxDUC{2514}{\sphinxunichar{2514}}
  \sphinxDUC{251C}{\sphinxunichar{251C}}
  \sphinxDUC{2572}{\textbackslash}
\fi
\usepackage{cmap}
\usepackage[T1]{fontenc}
\usepackage{amsmath,amssymb,amstext}
\usepackage{babel}



\usepackage{tgtermes}
\usepackage{tgheros}
\renewcommand{\ttdefault}{txtt}



\usepackage[Bjarne]{fncychap}
\usepackage[,numfigreset=1,mathnumfig]{sphinx}

\fvset{fontsize=auto}
\usepackage{geometry}


% Include hyperref last.
\usepackage{hyperref}
% Fix anchor placement for figures with captions.
\usepackage{hypcap}% it must be loaded after hyperref.
% Set up styles of URL: it should be placed after hyperref.
\urlstyle{same}

\addto\captionsenglish{\renewcommand{\contentsname}{Contents:}}

\usepackage{sphinxmessages}
\setcounter{tocdepth}{1}


        \usepackage{graphicx}
        \usepackage{background}

        \backgroundsetup{
          scale=1,
          color=black,
          opacity=1,
          angle=0,
          position=current page.north,
          contents={%
          \small\sffamily%
          \begin{minipage}{.22\textwidth}
          \vspace{1.65cm}
          \hspace{-0.175cm}
          \includegraphics[width=\linewidth,height=70pt,keepaspectratio]{../../images/eumetsat.png}
          \end{minipage}%
          \begin{minipage}{.8\textwidth}
          \vspace{2cm}
          \parbox[b]{.6\textwidth}{}\hfill \\
          \end{minipage}%
          }
        }

        \usepackage{fancyhdr}
        \pagestyle{fancy}
        \fancypagestyle{normal}{%
        \fancyhead{}
        \fancyhead[RE,RO]{\bf{project-docs/solution-design \\ , \today \\ EUMETSAT WP FCIDECOMP - Solution design}}
        \renewcommand{\headrulewidth}{0.5pt}
        \fancyfoot{}
        \fancyfoot[C]{\thepage}
        }
        \fancypagestyle{plain}{%
        \fancyhead{}
        \fancyhead[RE,RO]{\bf{project-docs/solution-design \\ , \today \\ EUMETSAT WP FCIDECOMP - Solution design}}
        \fancyfoot[CO,CE]{\thepage}
        }

        

\title{EUMETSAT WP FCIDECOMP - Solution design}
\date{Nov 10, 2021}
\release{}
\author{EUMETSAT}
\newcommand{\sphinxlogo}{\vbox{}}
\renewcommand{\releasename}{}
\makeindex
\begin{document}

\pagestyle{empty}

        \pagenumbering{Roman} %%% to avoid page 1 conflict with actual page 1

        \sphinxmaketitle

        \clearpage
        \pagenumbering{roman}
        \listoftables
        \clearpage
        \pagenumbering{arabic}

        
\pagestyle{plain}
\sphinxtableofcontents
\pagestyle{normal}
\phantomsection\label{\detokenize{index::doc}}



\chapter{Document Information}
\label{\detokenize{document_info:document-information}}\label{\detokenize{document_info::doc}}

\begin{savenotes}\sphinxattablestart
\centering
\begin{tabulary}{\linewidth}[t]{|T|T|}
\hline

\sphinxAtStartPar
Doc. id:
&\\
\hline
\sphinxAtStartPar
External version:
&\\
\hline
\sphinxAtStartPar
Author:
&
\sphinxAtStartPar
M. Cucchi (B\sphinxhyphen{}Open Solutions)
M. Bottaccio (B\sphinxhyphen{}Open Solutions)
\\
\hline
\end{tabulary}
\par
\sphinxattableend\end{savenotes}


\chapter{Introduction}
\label{\detokenize{introduction:introduction}}\label{\detokenize{introduction::doc}}

\section{Purpose}
\label{\detokenize{introduction:purpose}}
\sphinxAtStartPar
The document describes a design proposal for a maintainable solution allowing users to reliably decode FCI L1c products
compressed with CharLS.


\section{Reference Documents}
\label{\detokenize{introduction:reference-documents}}

\begin{savenotes}\sphinxatlongtablestart\begin{longtable}[c]{|\X{20}{100}|\X{30}{100}|\X{50}{100}|}
\sphinxthelongtablecaptionisattop
\caption{Reference documents\strut}\label{\detokenize{introduction:id1}}\\*[\sphinxlongtablecapskipadjust]
\hline
\sphinxstyletheadfamily 
\sphinxAtStartPar
\#
&\sphinxstyletheadfamily 
\sphinxAtStartPar
Title
&\sphinxstyletheadfamily 
\sphinxAtStartPar
Reference
\\
\hline
\endfirsthead

\multicolumn{3}{c}%
{\makebox[0pt]{\sphinxtablecontinued{\tablename\ \thetable{} \textendash{} continued from previous page}}}\\
\hline
\sphinxstyletheadfamily 
\sphinxAtStartPar
\#
&\sphinxstyletheadfamily 
\sphinxAtStartPar
Title
&\sphinxstyletheadfamily 
\sphinxAtStartPar
Reference
\\
\hline
\endhead

\hline
\multicolumn{3}{r}{\makebox[0pt][r]{\sphinxtablecontinued{continues on next page}}}\\
\endfoot

\endlastfoot

\sphinxAtStartPar
{[}CONDA\_VARIANTS{]}

\phantomsection\label{\detokenize{introduction:conda-variants}}&
\sphinxAtStartPar
conda\sphinxhyphen{}build \textendash{} Build variants
&
\sphinxAtStartPar
\sphinxurl{https://docs.conda.io/projects/conda-build/en/latest/resources/variants.html}
\\
\hline
\sphinxAtStartPar
{[}FCIDECOMP\_CONDA{]}

\phantomsection\label{\detokenize{introduction:fcidecomp-conda}}&
\sphinxAtStartPar
FCIDECOMP Conda recipe developed by Martin Raspaud (SMHI)
&
\sphinxAtStartPar
\sphinxurl{https://github.com/mraspaud/fcidecomp-conda-recipe/}
\\
\hline
\sphinxAtStartPar
{[}FCIDECOMP\_LATEST{]}

\phantomsection\label{\detokenize{introduction:fcidecomp-latest}}&
\sphinxAtStartPar
FCIDECOMP v1.0.2 repository
&
\sphinxAtStartPar
\sphinxurl{https://sftp.eumetsat.int/public/folder/UsCVknVOOkSyCdgpMimJNQ/User-Materials/Test-Data/MTG/MTG\_FCI\_L1C\_Enhanced-NonN\_TD-272\_May2020/FCI\_Decompression\_Software\_V1.0.2/EUMETSAT-FCIDECOMP\_V1.0.2.tar.gz}
\\
\hline
\sphinxAtStartPar
{[}FCIDECOMP\_WPD{]}

\phantomsection\label{\detokenize{introduction:fcidecomp-wpd}}&
\sphinxAtStartPar
Work Package Description
&
\sphinxAtStartPar
EUM/SEP/WPD/21/1244304
\\
\hline
\sphinxAtStartPar
{[}HDF5PLUGIN{]}

\phantomsection\label{\detokenize{introduction:hdf5plugin}}&
\sphinxAtStartPar
\sphinxcode{\sphinxupquote{hdf5plugin}} python package
&
\sphinxAtStartPar
\sphinxurl{https://github.com/silx-kit/hdf5plugin}
\\
\hline
\sphinxAtStartPar
{[}HDFVIEW{]}

\phantomsection\label{\detokenize{introduction:hdfview}}&
\sphinxAtStartPar
HDFView Software
&
\sphinxAtStartPar
\sphinxurl{https://www.hdfgroup.org/downloads/hdfview/}
\\
\hline
\sphinxAtStartPar
{[}NETCDF\_JAVA{]}

\phantomsection\label{\detokenize{introduction:netcdf-java}}&
\sphinxAtStartPar
Unidata \sphinxhyphen{} NetCDF\sphinxhyphen{}Java
&
\sphinxAtStartPar
\sphinxurl{https://www.unidata.ucar.edu/software/netcdf-java/}
\\
\hline
\sphinxAtStartPar
{[}NETCDF\_JAVA\_GITHUB{]}

\phantomsection\label{\detokenize{introduction:netcdf-java-github}}&
\sphinxAtStartPar
NetCDF\sphinxhyphen{}C for reading (nj22Config.xml) in non\sphinxhyphen{}Unidata netCDF\sphinxhyphen{}Java based tools
&
\sphinxAtStartPar
\sphinxurl{https://github.com/Unidata/thredds/issues/1063}
\\
\hline
\sphinxAtStartPar
{[}PANOPLY{]}

\phantomsection\label{\detokenize{introduction:panoply}}&
\sphinxAtStartPar
Panoply netCDF, HDF and GRIB Data Viewer
&
\sphinxAtStartPar
\sphinxurl{https://www.giss.nasa.gov/tools/panoply/}
\\
\hline
\end{longtable}\sphinxatlongtableend\end{savenotes}


\chapter{Creation of canonical repository}
\label{\detokenize{canonical_repository:creation-of-canonical-repository}}\label{\detokenize{canonical_repository::doc}}
\sphinxAtStartPar
The first step of the solution design consists in the creation of a single canonical repository, at EUMETSAT GitLab,
hosting the official version of the FCIDECOMP software. This repository will contain all the code necessary to build the
software and make it available as a HDF dynamically loaded filter.


\section{Repository initialization}
\label{\detokenize{canonical_repository:repository-initialization}}
\sphinxAtStartPar
Initially, FCIDECOMP v1.0.2 (taken from {\hyperref[\detokenize{introduction:fcidecomp-latest}]{\sphinxcrossref{\DUrole{std,std-ref}{EUMETSAT sFTP repository}}}}) will be taken as blueprint
for the development of the solution codebase.

\sphinxAtStartPar
The repository will be put under configuration control. A new minor release adding README, BUILD, INSTALL, and LICENCE
files, starting the Changelog, codifying the use of semantic versioning for future versions and adding a standardised
build system will then be published.


\section{Test suite}
\label{\detokenize{canonical_repository:test-suite}}
\sphinxAtStartPar
An initial test suite (at least against nominal conditions) will be implemented following the V\&V strategy defined in
{[}add reference{]}. As an initial proposal, we would implement most or all the tests as automated tests against the Python
interface.


\section{Test data}
\label{\detokenize{canonical_repository:test-data}}
\sphinxAtStartPar
A preliminary set of test data taken from the MTG FCI L1C test data will be added to ensure a consistent and permanent
dataset to execute tests.


\chapter{Support and integration with external tools}
\label{\detokenize{support_and_integration:support-and-integration-with-external-tools}}\label{\detokenize{support_and_integration::doc}}
\sphinxAtStartPar
In the following paragraphs outlines of the strategy to ensure that the FCIDECOMP software support all the required
systems and usage patterns are reported.


\section{Integration with HDF tools based on netCDF\sphinxhyphen{}C}
\label{\detokenize{support_and_integration:integration-with-hdf-tools-based-on-netcdf-c}}
\sphinxAtStartPar
The current implementation of the FCIDECOMP software ({\hyperref[\detokenize{introduction:fcidecomp-latest}]{\sphinxcrossref{\DUrole{std,std-ref}{v1.0.2}}}}) already satisfies the HDF5
filters interface. So, once installed, it can easily be invoked by utilities relying on the \sphinxcode{\sphinxupquote{netcdf\sphinxhyphen{}c}} library (such
as \sphinxcode{\sphinxupquote{nccopy}}), provided that:
\begin{itemize}
\item {} 
\sphinxAtStartPar
the location of the filter is specified in a specific environment variable, \sphinxcode{\sphinxupquote{HDF5\_PLUGIN\_PATH}};

\item {} 
\sphinxAtStartPar
the correct filter id, if required by the utility, is specified (32018 for FCIDECOMP);

\item {} 
\sphinxAtStartPar
any other parameter requested by the utility is also specified.

\end{itemize}

\sphinxAtStartPar
In order to provide a baseline support for CLI usage of the FCIDECOMP software, we will focus on its integration with
\sphinxcode{\sphinxupquote{nccopy}}. To foster such integration, we will:
\begin{itemize}
\item {} 
\sphinxAtStartPar
have the FCIDECOMP software package install the filterâ€™s library to a specific path at installation

\item {} 
\sphinxAtStartPar
have the \sphinxcode{\sphinxupquote{HDF5\_PLUGIN\_PATH}} environment variable automatically set each time a conda environment where FCIDECOMP is installed get activated

\item {} 
\sphinxAtStartPar
document how to call \sphinxcode{\sphinxupquote{nccopy}} to decompress files using the FCIDECOMP filter

\end{itemize}


\section{Integration with Python}
\label{\detokenize{support_and_integration:integration-with-python}}
\sphinxAtStartPar
HDF5 filters are typically used in Python programs by invoking the \sphinxcode{\sphinxupquote{h5py}} library, which may in turn require
additional packages to provide specific filters. An example of such additional packages is the \sphinxcode{\sphinxupquote{hdf5plugin}} library,
which makes the FCIDECOMP filter, among others, available to \sphinxcode{\sphinxupquote{h5py}}.

\sphinxAtStartPar
To grant integration with Python we will develop a package specific for the FCIDECOMP filter, initially as a
stripped\sphinxhyphen{}down version of {\hyperref[\detokenize{introduction:hdf5plugin}]{\sphinxcrossref{\DUrole{std,std-ref}{hdf5plugin}}}}. We will also try to contact maintainers of the \sphinxcode{\sphinxupquote{hdf5plugin}}
package to evaluate synergies and reduce conflicts. In this direction, Initial proposal is to have a small package which
only includes the FCIDECOMP plugin support from \sphinxcode{\sphinxupquote{hdf5plugin}}, and to propose the \sphinxcode{\sphinxupquote{hdf5plugin}} maintainers to use it
as a sub\sphinxhyphen{}module dependency in \sphinxcode{\sphinxupquote{hdf5plugin}} in order not to break their interfaces and not to duplicate effort; in
this case, this small python package would be maintained by B\sphinxhyphen{}Open (for the duration of the contract) on behalf of
EUMETSAT.


\section{Integration with EUMETSAT Data\sphinxhyphen{}Tailor}
\label{\detokenize{support_and_integration:integration-with-eumetsat-data-tailor}}
\sphinxAtStartPar
At the moment, the Data Tailor supports reading compressed FCI L1C products through the optional
\sphinxcode{\sphinxupquote{epct\_plugin\_mtg4africa}} customisation plugin, which in turns install FCIDECOMP by installing with \sphinxcode{\sphinxupquote{pip}} the
\sphinxcode{\sphinxupquote{hdf5plugin}} package. Note that the same Data Tailor plugin also uses the FCICOMP software to compress output data,
and that such compressor is built when building the Data Tailor plugin package. This has potential fo dependency
conflicts, as the compressor and te decompressor rely in part on the same dependencies.

\sphinxAtStartPar
The approach to integrate the described solution with the Data Tailor will therefore include a revision of the current
build and installation approach for the \sphinxcode{\sphinxupquote{epct\_plugin\_mtg4africa}} customisation plugin. The most promising
direction is having the plugin install FCIDECOMP from the conda package, so that dependency conflicts are to some
extent managed by conda.


\section{Integration with tools based on netCDF\sphinxhyphen{}Java}
\label{\detokenize{support_and_integration:integration-with-tools-based-on-netcdf-java}}
\sphinxAtStartPar
Use of the FCIDECOMP decompressor in Java may be complex to address. There is evidence that Unidata netCDF\sphinxhyphen{}Java based
tools may work with HDF5 dynamic filters, but it is less clear whether they can still be used with non\sphinxhyphen{}Unidata
applications based on NetCDF\sphinxhyphen{}Java (e.g. panoply). The main problem is related to the fact NetCDF\sphinxhyphen{}Java is essentially
independent from HDF\sphinxhyphen{}Java (while NetCDF\sphinxhyphen{}C is based on HDF\sphinxhyphen{}C), and while HDF\sphinxhyphen{}Java can use HDF dynamically loaded filters
as NetCDF\sphinxhyphen{}C based applications do, NetCDF\sphinxhyphen{}Java cannot.

\sphinxAtStartPar
A promising solution (see this {\hyperref[\detokenize{introduction:netcdf-java-github}]{\sphinxcrossref{\DUrole{std,std-ref}{github issue}}}}) consists in instructing NetCDF\sphinxhyphen{}Java based
applications to read files using the NetCDF\sphinxhyphen{}C library, via a simple tweak to a configuration file. A preliminary test
showed that, in the considered environment, the described solution is able to let {\hyperref[\detokenize{introduction:panoply}]{\sphinxcrossref{\DUrole{std,std-ref}{Panoply}}}} (one of the
most used NetCDF\sphinxhyphen{}Java based applications) decompress NetCDFs using the FCIDECOMP plugin. We will explore how the
solution behaves with other notable NetCDF\sphinxhyphen{}Java based applications, such as {\hyperref[\detokenize{introduction:hdfview}]{\sphinxcrossref{\DUrole{std,std-ref}{HDFView}}}} and
{\hyperref[\detokenize{introduction:netcdf-java}]{\sphinxcrossref{\DUrole{std,std-ref}{ToolsUI}}}}.

\sphinxAtStartPar
In the case this solution is adopted, it will only require to be documented as an effective work\sphinxhyphen{}around to use the
FCIDECOMP plugin with NetCDF\sphinxhyphen{}Java based applications.


\chapter{Packaging strategy}
\label{\detokenize{packaging_strategy:packaging-strategy}}\label{\detokenize{packaging_strategy::doc}}
\sphinxAtStartPar
In the following paragraphs outlines of the strategy to build and package the FCIDECOMP software in order to ensure
support for and integration with all the required systems are reported.


\section{Supported platforms}
\label{\detokenize{packaging_strategy:supported-platforms}}\label{\detokenize{packaging_strategy:id1}}
\sphinxAtStartPar
Based on the {\hyperref[\detokenize{introduction:fcidecomp-wpd}]{\sphinxcrossref{\DUrole{std,std-ref}{Work Package Description}}}} and not considering OS that already have reached their
End of Life, the FCIDECOMP software will support the following platforms:
\begin{itemize}
\item {} 
\sphinxAtStartPar
Windows 10, 32 and 64 bit

\item {} 
\sphinxAtStartPar
Ubuntu 18.04, Ubuntu 20.04 64 bit

\item {} 
\sphinxAtStartPar
CentOS 7 64 bit

\end{itemize}


\section{Building the binaries}
\label{\detokenize{packaging_strategy:building-the-binaries}}
\sphinxAtStartPar
The build system for the software binaries will be initially drawn from the one used in the
{\hyperref[\detokenize{introduction:fcidecomp-latest}]{\sphinxcrossref{\DUrole{std,std-ref}{FCIDECOMP v1.0.2 source code}}}}, and adapted from there to guarantee support for all the
required systems.


\section{Packaging as a Conda package}
\label{\detokenize{packaging_strategy:packaging-as-a-conda-package}}
\sphinxAtStartPar
Packages will be built using Conda, as it provides standardised environments with a large set of pre\sphinxhyphen{}compiled packages.
From the point of view of Conda, the operating systems listed in the {\hyperref[\detokenize{packaging_strategy:supported-platforms}]{\sphinxcrossref{\DUrole{std,std-ref}{Supported platforms}}}}
paragraph can be considered as two groups of OS: in Conda standardised environment it is enough to build the package for
one Linux distribution in order to make it compatible with other Linux distributions. So two conda packages will be
released: one for Linux distributions, and one for Windows 10.

\sphinxAtStartPar
These conda packages will install both the FCIDECOMP libraries and its Python bindings. As a blueprint for the
conda recipes, the {\hyperref[\detokenize{introduction:fcidecomp-conda}]{\sphinxcrossref{\DUrole{std,std-ref}{Conda recipe}}}} for the packaging of FCIDECOMP mantained by Martin Raspaud
from the Swedish Meteorological and Hydrological Institute will be used.

\sphinxAtStartPar
The initial aim will be to support HDF5 1.10, and then the use of {\hyperref[\detokenize{introduction:conda-variants}]{\sphinxcrossref{\DUrole{std,std-ref}{conda variants}}}} will be
explored to support multiple versions on the same build platform.

\sphinxAtStartPar
Conda packages will be uploaded to EUMETSAT Anaconda repository.


\section{CI/CD pipelines}
\label{\detokenize{packaging_strategy:ci-cd-pipelines}}
\sphinxAtStartPar
We will implement simple CI/CD pipelines to compile, build, test and possibly upload the conda packages to the conda
repository.

\sphinxAtStartPar
At least two GitLab runners will be implemented, one with a Docker executor on Linux and the other on Windows.


\chapter{Deployment}
\label{\detokenize{deployment:deployment}}\label{\detokenize{deployment::doc}}
\sphinxAtStartPar
The following paragraphs outline the strategy to deploy the FCIDECOMP package.


\section{CI/CD pipelines}
\label{\detokenize{deployment:ci-cd-pipelines}}
\sphinxAtStartPar
We will implement simple GitLab CI/CD pipelines to compile, build, test and possibly upload the conda packages to
EUMETSAT Anaconda repository.

\sphinxAtStartPar
At least two GitLab runners will be implemented, one with a Docker executor on Linux and the other with a Shell
executor on Windows.


\chapter{Appendix 1 \sphinxhyphen{} Traceability matrix}
\label{\detokenize{a_traceability_matrix:appendix-1-traceability-matrix}}\label{\detokenize{a_traceability_matrix::doc}}

\chapter{Appendix 2 \sphinxhyphen{} List of users and developers currently using FCIDECOMP}
\label{\detokenize{a_users_using_fcidecomp:appendix-2-list-of-users-and-developers-currently-using-fcidecomp}}\label{\detokenize{a_users_using_fcidecomp::doc}}

\chapter{Appendix 3 \sphinxhyphen{} Design justifications}
\label{\detokenize{a_design_justifications:appendix-3-design-justifications}}\label{\detokenize{a_design_justifications::doc}}


\renewcommand{\indexname}{Index}
\printindex
\end{document}